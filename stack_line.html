<!DOCTYPE html>
<html>
<head>
    <title>Stacked Bar Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .chart {
            width: 800px;
            height: 400px;
        }
    </style>
</head>
<body>
    <div id="chart" class="chart"></div>
    <div>
        <label for="year-slider">Select Year:</label>
        <input type="range" id="year-slider" min="1900" max="2100" onchange="updateChart()">
        <span id="selected-year"></span>
    </div>

    <script>
        // Load the data from the CSV file
        d3.csv("StreamingPlatform.csv").then(function(data) {
            // Function to filter data based on the selected year
            function filterDataByYear(selectedYear) {
                return data.filter(function(d) {
                    var year = parseInt(d.date_added.split(",")[1]);
                    return year === selectedYear;
                });
            }

            // Set up the chart dimensions
            var margin = {top: 20, right: 20, bottom: 30, left: 40};
            var width = 800 - margin.left - margin.right;
            var height = 400 - margin.top - margin.bottom;

            // Create the SVG container
            var svg = d3.select("#chart")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Set up the scales
            var x = d3.scaleBand()
                      .range([0, width])
                      .padding(0.1);

            var y = d3.scaleLinear()
                      .range([height, 0]);

            var color = d3.scaleOrdinal(d3.schemeCategory10);

            // Function to update the chart based on the selected year
            function updateChart() {
                var selectedYear = parseInt(document.getElementById("year-slider").value);
                var filteredData = filterDataByYear(selectedYear);

                // Filter the data for the first 5 genres
                var filteredGenreData = filteredData.filter(d => ["Top1", "Top2", "Top3", "Top4", "Top5"].includes(d.TopNGenre));

                // Group the data by genre and platform
                var groupedData = d3.group(filteredGenreData, d => d.listed_in, d => d.Platform);

                // Calculate the count of each platform for each genre
                var stackedData = Array.from(groupedData, ([genre, platformData]) => ({
                    genre: genre,
                    platforms: Array.from(platformData, ([platform, movies]) => ({
                        platform: platform,
                        count: movies.length
                    }))
                }));

                // Sort the platforms within each genre by count in descending order
                stackedData.forEach(genreData => {
                    genreData.platforms.sort((a, b) => b.count - a.count);
                    genreData.platforms = genreData.platforms.slice(0, 5); // Keep only the top 5 platforms
                });

                // Update the scales with new data
                x.domain(stackedData.map(d => d.genre));
                y.domain([0, d3.max(stackedData, d => d3.max(d.platforms, p => p.count))]);

                // Remove previous bars
                svg.selectAll(".stack").remove();

                // Create the stacked bars
                var stack = svg.selectAll(".stack")
                   .data(stackedData)
                   .enter().append("g")
                   .attr("class", "stack")
                   .attr("transform", d => "translate(" + x(d.genre) + ",0)")
                   .selectAll("rect")
                   .data(d => d.platforms)
                   .enter().append("rect")
                   .attr("x", d => x.bandwidth() / 4)
                   .attr("y", d => y(d.count))
                   .attr("width", x.bandwidth() / 2)
                   .attr("height", d => height - y(d.count))
                   .style("fill", d => color(d.platform));

                // Add the x-axis
                svg.append("g")
                   .attr("class", "x-axis")
                   .attr("transform", "translate(0," + height + ")")
                   .call(d3.axisBottom(x));

                // Add the y-axis
                svg.append("g")
                   .attr("class", "y-axis")
                   .call(d3.axisLeft(y));

                // Update the selected year text
                document.getElementById("selected-year").textContent = selectedYear;
            }

            // Initialize the chart
            updateChart();
        });
    </script>
</body>
</html>
