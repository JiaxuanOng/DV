<!DOCTYPE html>
<html>
  <head>
    <title>Interactive Map Visualization</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
      #map {
        width: 800px;
        height: 600px;
      }
      .tooltip {
        position: absolute;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #ccc;
        pointer-events: none;
      }
      .legend {
        position: absolute;
        top: 20px;
        right: 20px;
      }
      .legend-title {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .legend-scale {
        display: flex;
        flex-direction: column;
      }
      .legend-scale-color {
        width: 20px;
        height: 200px;
      }
      .legend-scale-labels {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: space-between;
        height: 200px;
      }
      .legend-scale-labels span {
        font-size: 12px;
        line-height: 1.2;
      }
    </style>
  </head>
  <body>
    <div>
      <label for="platform">Choose Platform:</label>
      <input type="radio" name="platform" value="hulu" checked>Hulu
      <input type="radio" name="platform" value="netflix">Netflix
      <input type="radio" name="platform" value="amazon">Amazon
      <input type="radio" name="platform" value="disney">Disney
    </div>
    <div>
      <label for="type">Choose Type:</label>
      <input type="radio" name="type" value="Movie" checked>Movie
      <input type="radio" name="type" value="TV Show">TV Show
    </div>
    <div id="map"></div>

    <div class="tooltip" style="display: none;"></div>

    <svg class="legend" width="100" height="220">
      <g class="legend-scale">
        <rect class="legend-scale-color"></rect>
        <g class="legend-scale-labels"></g>
      </g>
    </svg>

    <script>
      const width = 800;
      const height = 600;

      const svg = d3
        .select("#map")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const tooltip = d3.select(".tooltip");

      const colorScale = d3.scaleSequential(d3.interpolateReds);

      // Load the countries geoJSON data
      d3.json("https://datahub.io/core/geo-countries/r/countries.geojson").then(function (mapData) {
	  const countries = mapData.features;

	  const countryNameMap = {};
	  countries.forEach((country) => {
		const countryName = country.properties.ADMIN;
		countryNameMap[countryName] = country;
	  });

        const projection = d3.geoMercator().fitSize([width, height], mapData);
        const path = d3.geoPath().projection(projection);

        d3.csv("StreamingPlatform.csv").then(function (data) {
          let filteredData = data;
          let maxSum = 0; // Maximum sum of shows/movies

          updateMap();

          d3.selectAll('input[name="platform"], input[name="type"]').on("change", function () {
            updateMap();
          });
		function fixCountryName(countryName) {
				// Special cases for country name differences
				if (countryName === "United States of America") {
				  return "United States";
				}
				return countryName;
			  }
        function updateMap() {
			// Filter data based on platform and type
				const platformFilter = d3.select('input[name="platform"]:checked').node().value;
				const typeFilter = d3.select('input[name="type"]:checked').node().value;
				filteredData = data.filter((d) => d.platform === platformFilter && d.type === typeFilter);

				// Aggregate the sum of shows/movies by country
				const sumByCountry = filteredData.reduce((acc, d) => {
				  const countryName = fixCountryName(d.country);
					  if (countryName) {
						if (!acc[countryName]) {
						  acc[countryName] = 0;
						}
						acc[countryName]++;
					  }
					  return acc;
					}, {});

            // Find the maximum sum for scaling the color gradient
            maxSum = d3.max(Object.values(sumByCountry));

            // Update the color scale domain based on the maximum sum
            colorScale.domain([0, maxSum]);

            svg
			  .selectAll("path")
			  .data(countries)
			  .join("path")
			  .attr("d", path)
			  .attr("fill", (d) => {
				const countryName = fixCountryName(d.properties.ADMIN);
				//const fixedCountryName = fixCountryName(countryName); // Fix the country name again
				const countrySum = sumByCountry[countryName];
				if (countrySum) {
				  return colorScale(countrySum);
				}
				return "white";
			  })
			  .attr("stroke", "black") // Set the stroke color to black
  .attr("stroke-width", 0.5) // Set the stroke width
              .on("mouseover", function (event, d) {
                d3.select(this).attr("stroke", "black");

                // Get mouse position
                const [x, y] = d3.pointer(event);

                // Display tooltip with country name and show count
                tooltip
                  .style("left", x + "px")
                  .style("top", y + "px")
                  .style("display", "block")
                  .text(d.properties.ADMIN + ": " + getShowCount(fixCountryName(d.properties.ADMIN)));
              })
              .on("mouseout", function () {
                d3.select(this).attr("stroke", null);

                // Hide tooltip
                tooltip.style("display", "none");
              });
		
            // Update the color legend
            const legendScale = d3.scaleLinear().domain([0, maxSum]).range([200, 0]);
            const legendColors = Array.from({ length: 10 }, (_, i) => colorScale(i * (maxSum / 10)));
            const legendLabels = Array.from({ length: 10 }, (_, i) => Math.round(i * (maxSum / 10)));

            d3.select(".legend-scale-color")
              .attr("fill", "url(#gradient)")
              .attr("x", 0)
              .attr("y", 0)
              .attr("width", 20)
              .attr("height", 200);

            const legendGradient = svg
              .append("defs")
              .append("linearGradient")
              .attr("id", "gradient")
              .attr("x1", "0%")
              .attr("x2", "0%")
              .attr("y1", "0%")
              .attr("y2", "100%");

            legendGradient
              .selectAll("stop")
              .data(legendColors)
              .enter()
              .append("stop")
              .attr("offset", (_, i) => i * 100 / 9 + "%")
              .attr("stop-color", d => d);

            d3.select(".legend-scale-labels")
              .selectAll("span")
              .data(legendLabels)
              .join("span")
              .text(d => d);
          }

          function getShowCount(country) {
            const count = filteredData.filter(d => d.country === country);
            const distinctTitles = new Set(count.map(d => d.title));
            return distinctTitles.size;
          }
        });
      });
    </script>
  </body>
</html>
